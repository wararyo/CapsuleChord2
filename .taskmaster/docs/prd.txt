<context>
# 概要
これはCapsuleChordという電子楽器のファームウェアです。
CapsuleChordはスタンドアローンで動作し、ゲームコントローラーのような形をしています。
通常の電子楽器が単音を鳴らすものであるのに対し、CapsuleChordは和音を鳴らすことを主な目的としているのが特徴です。

作曲者にとってハーモニーは重要な音楽の一要素です。
作曲者が作曲をするとき、通常はMIDI接続の鍵盤を机の上に置いておき、鍵盤でハーモニーを奏でることで響きや音色を確認します。
しかし、外出先で作曲をしたいとき、MIDI鍵盤は大きく、持ち歩くのは現実的ではありません。
かといって持ち歩けるほど小さな鍵盤では一つ一つのボタンが小さく、和音を奏でるのは困難です。
CapsuleChordはこの問題を解消し、持ち歩けるほどの大きさでありながら和音を奏でるのに快適なインターフェースを提供します。

CapsuleChordのその他の機能として、いくつかの「アプリ」を搭載しています。
「アプリ」により、和音をアルペジオに変換する、ドラムを追加するなどの機能が使用でき、単に和音を入力するにとどまらない、グルーヴボックス的な役割も果たします。

CapsuleChordは主に作曲者を対象にしていますが、音楽ガジェットに興味のある人、ギターやピアノに挫折してしまった人も対象にしています。

# インターフェース

CapsuleChordは下記の入力インターフェースを備えています。

* 左キーパッド(3x3)
* 右キーパッド(3x3)
* LRボタン
* LT/RTボタン
* 戻るボタン
* ホームボタン
* メニューボタン
* 6軸IMU(加速度センサー+ジャイロセンサー)

CapsuleChordは下記の出力インターフェースを備えています。

* 内蔵スピーカー
* イヤホン出力
* キーパッドLED (左/右キーパッドの各キーは4段階で発光できる)

CapsuleChordは下記の入出力インターフェースを備えています。

* タッチスクリーン(240x320px)
* USB-C端子 (MIDI入出力およびPCとの通信に使用)
* BLE MIDI
* GROVE端子(I2Cによる拡張)

# 主要機能

## 和音の演奏

CapsuleChordのコア機能です。
CapsuleChordは(初期設定で)左キーパッドを押下することで和音が出力されます。
右キーパッドは修飾キーとして使われ、和音にセブンスを付加するなどの変更を加えます。

### 左キーパッドのキーバインド

音楽理論の言葉として「ダイアトニックコード」という概念があり、調ごとに7つのダイアトニックコードが割り当てられています。
さらに、それらのダイアトニックコードは根音の低いものから順に1から7の番号をつけて呼ばれることが多いです。
左キーパッドは(初期設定で)左下から順に1, 2, 3, 4, 5, 6, 7, カスタムキー1, カスタムキー2の和音が割り当てられています。

カスタムキー1/2は、よく使うノンダイアトニックコード(例: bVII、bIIIなど)をワンボタンで演奏可能にするために使用します。

### 右キーパッドのキーバインド

右キーパッドのキーを押しながら左キーパッドを押下することで、鳴らす和音に変化を加えることができます。
これにより、ダイアトニックコードだけにとどまらない多彩なノンダイアトニックコードも演奏することができます。

右キーパッドは(初期設定で)左下から順にフラットファイブ, 三度のメジャー/マイナー切り替え, sus4, セブンスのメジャーマイナー切り替え, aug, 13th, 9th, BlackAdderです。

### その他のキーバインド

LRキーやLT/RTキーを押しながら左キーパッドを押下すると下記のような変化が生じます。

* Lキー: 半音下げる
* Rキー: 半音上げる
* LTキー: 転回を一つ下げる
* RTキー: 転回を一つ上げる

### 調の切り替え

調を切り替えることでさらに多彩なコードを演奏できます。

調としてはメジャーキーとマイナーキーのみをサポートします。その他のモード(ドリアン、フリジアンなど)は当面対象外とします。
転調時、現在押下中の和音は変化しません。

### ボイシング (将来的に実装)

オープンボイシング/クローズボイシングのどちらを使用するかについてはユーザーが選択可能です。
直前に鳴らしていた和音と自然につながるように転回系を自動的に選択します。
これらは後述する実装フェーズ「より高度な操作による和音の演奏」にて検討します。

## 内蔵音源

CapsuleChordは音源を内蔵しており、標準設定では出力された和音は内蔵音源を通して内蔵スピーカーやイヤホン端子から音声が出力されます。
内蔵音源は16個のチャンネルを持ち、チャンネルごとにピアノ、ギター、ベース、ドラムなどの音色を割り当て、同時に演奏することができます。
ただし、最後のチャンネルはシステム音のために予約されており、メトロノーム音などに使用されます。

### 技術仕様

* **音源方式**: サンプリング音源 (CapsuleSamplerライブラリを使用)
* **最大ポリフォニー**: 32和音
* **音色プリセット**:
  - ピアノ x1
  - アコースティックギター x2
  - ベース x2
  - ドラムセット x3
  - (将来的に拡張可能)
* **音域制限**: 当面制限なし (必要に応じて後で検討)
* **レイテンシ目標**: キー押下から発音まで20ミリ秒以下 (内蔵音源使用時)

## 出力デバイスの切り替え

和音は標準では内蔵音源に出力されますが、MIDI信号としてPCのような外部デバイスに出力することができます。
したがって、下記の出力デバイスを切り替えながら使うことができます。
各出力デバイスは同時には使用できません。

* 内蔵音源
* USB MIDI
* BLE MIDI

### MIDI機能

* **MIDI出力**: USB-CDC経由およびBLE経由でMIDI信号を送信
* **MIDIチャンネル割り当て**: CapsuleSamplerライブラリが管理 (本プロジェクトでは考慮不要)
* **MIDI入力**: 当面サポートしない
* **MIDIクロック同期**: サポート予定 (外部デバイスとのテンポ同期)

## テンポ

BPMを指定し「再生」することでビートを管理し、音楽的なタイミングで特定の動作を起こすことができます。
主に後述する「アプリ」で使用します。

## アプリ

アプリを用いることで、和音の演奏をより多彩にしたり、他のパートを加えて豊かなサウンドを楽しむことができます。
アプリには下記のような動作が許可されています。

* アプリ専用の画面を持つ
* バックグラウンド動作(画面上にそのアプリの画面ではない別の画面が表示されている時でも動作可能)
* 現在の出力デバイスにMIDIメッセージを出力
* キー入力を受け取り、「消化」する(キー入力をアプリが使用し、和音の演奏に使用しない)
* キーLEDの制御
* 和音の演奏を受け取り、変化させる
* MIDI出力を受け取り、変化させる

### メトロノームアプリ

メトロノームアプリは拍に合わせてメトロノーム音を鳴らします。(内蔵音源のチャンネル16を使用)

### シーケンサーアプリ

シーケンサーアプリは和音を時間的に分散して演奏する機能を持ちます。
一般的にはアルペジエーターと呼ばれることもあります。
ギターの演奏を再現するといった使い方も可能です。

分散のさせ方は端末上で編集できるほか、プリセットとして保存することも可能です。

### ドラムアプリ

ドラムアプリはあらかじめ指定されたドラムパターンを演奏します。
ドラムパターンは端末上で編集できるほか、プリセットとして保存することも可能です。
パターン編集のUIとしては、16ステップシーケンサー方式を採用します。

### コードガイドアプリ

あらかじめ収録されたコード進行を表示しながら演奏することで、演奏の練習やコード理論の理解に役立てます。
コード進行は端末上で編集できるほか、プリセットとして保存することも可能です。

## メニュー

メニューキーを押すことでメニューに入ります。
メニューからは下記のような設定を行うことができます。

* 操作
　* カスタムキー割り当て
* 演奏
  * 調
  * キー
* 出力
  * 出力先
  * Bluetooth接続解除
  * スピーカー音量
  * ヘッドホン音量
* 表示
  * 画面の明るさ
  * ディグリーネームで表示/コードネームで表示
  * コード表記
  * 電池残量を常に表示
* システム
  * 機内モード
  * サイレントモード
  * ネットワーク
  * 言語
  * ライセンス
  * ファームウェア情報
  * 初期設定に戻す

また、各アプリはアプリごとのメニューを持ちます。

## PCへの接続

コンパニオンアプリをインストールしたPCとUSB接続することで下記を実現します。

* MIDI入出力 (DAW上でMIDI鍵盤のように使える)
* シーケンサーアプリのパターン編集
* ドラムアプリのパターン編集
* コードガイドアプリのパターン編集/コード進行をMIDIとして出力
* 設定の変更
* ファームウェアアップデート

### 通信仕様

* **プロトコル**: USB-CDC (シリアル通信)
* **リアルタイム同期**: PC上でパターン編集中にデバイスでリアルタイムプレビュー可能
* **データフォーマット**: JSON形式を想定 (詳細は実装フェーズで決定)

# ユーザーエクスペリエンス

## PCで作曲の補助デバイスとして使用 (作曲者)

1. CapsuleChordとPCをUSBまたはBluetoothで接続
2. DAWを起動
3. コード進行を考案する時やシンセサイザーの音色を確認する際にMIDI鍵盤の代わりとして使用

## 作曲のアイデアを広げる道具として使用 (作曲者)

1. 外出先でCapsuleChordをスタンドアローンで起動
2. ドラムアプリでドラムパターンを演奏
3. パターンやコード進行を様々に変えながら新しい楽曲のアイデアを考案
4. コードガイドアプリを用いてコード進行を保存
5. 帰宅後、コンパニオンアプリを用いてコード進行をMIDI化、DAWを起動し読み込ませることで考案した楽曲のアイデアをもとに作業を行う

## 弾き語りの道具として使用 (音楽愛好家)

1. インターネット上に存在するコード進行共有サイトで、好きな音楽のコード進行を調べる
2. 既存のブラウザ拡張機能を用いてコード進行をディグリーネームに変換する
3. コード進行を見ながらCapsuleChordを演奏、弾き語りを楽しむ

</context>
<PRD>
# 技術アーキテクチャ

下記の製品や技術を使用します。

* M5Stack CoreS3 (MCUの一種 ESP32-S3 を搭載したマイコンボード)
* PlatformIO
* ArduinoESP32
* M5Unified
* LVGL
* CapsuleSampler (サンプリング音源ライブラリ)

## ストレージとデータ永続化

### パターンデータ保存

* **保存先優先順位**:
  1. SDカード (優先)
  2. SPIFFS (SDカードが挿入されていない場合のフォールバック)
* **ファイル形式**: 1パターン1JSONファイル
* **対象データ**:
  - シーケンサーパターン
  - ドラムパターン
  - コードガイドパターン
* **保存可能数**:
  - 理想: ストレージ容量が許す限り無制限
  - 実装上の上限: 128パターン (実装難易度に応じて調整可)

### 設定データ保存

* **保存先優先順位**:
  1. SDカード (優先)
  2. SPIFFS (SDカードが挿入されていない場合のフォールバック)
* **ファイル形式**: JSON
* **保存内容**:
  - ユーザー設定 (音量、明るさ、表示モードなど)
  - カスタムキーバインド
  - 最後に使用した音色/出力先など

# 画面

各画面の画面設計についてはdocsフォルダ内に格納されています。

## ホーム画面

和音を演奏する画面であり、あらゆる操作を行う起点となる画面です。
下記より構成されます。

* 演奏中の和音のコードネーム表示
* 現在のテンポの表示
* 現在のスケールの表示
* バックグラウンド動作中のアプリ一覧 (最大6個表示)
* 現在の出力先の表示
    * (内蔵音源の場合) 音色の表示
* バッテリー残量

## メニュー画面

ホーム画面でメニューボタンを押すとメニュー画面に遷移します。

## アプリ一覧画面

ホーム画面でホームボタンを押すとアプリ一覧画面に遷移します。

## 各アプリの画面

アプリ一覧画面でアプリを選択すると、そのアプリの画面に遷移します。

# 開発ロードマップ

## 1. 最低限の和音の演奏

* キー操作によって和音を演奏することができる
* 出力デバイスは内蔵音源のみを考慮
* 音色の変更を考慮しない
* キーバインドの変更を考慮しない(固定されたキーバインド)

## 2. アプリ

* 下記のアプリが使用できる
    * メトロノームアプリ
    * シーケンサーアプリ (パターンの編集/切り替えはできなくて良い)
    * ドラムパターンアプリ (パターンの編集/切り替えはできなくて良い)
    * ベースアプリ (パターンの編集/切り替えはできなくて良い)
    * コードガイドアプリ (コード進行の作成/編集はできなくて良い)
* アプリ一覧画面からアプリの起動や動作の切り替えを行うことができる

## 3. より高度な操作による和音の演奏

* ジャイロ機能を用いて転調できる
* ホーム画面より音色を変更できる
* タップ操作によりテンポを変更できる
* オープン/クローズボイシングを選択できる
* 直前の和音と自然につながる転回形が自動で選択される (スムーズなボイスリーディング)

## 4. 複数の出力デバイス

* BLE MIDIやUSB接続でのMIDI出力が使用できる
* ホーム画面上で出力デバイスを切り替えることができる
* MIDIクロック同期機能 (外部デバイスとのテンポ同期)

## 5. 設定およびカスタマイズ

* メニュー画面があり、メニューから各種設定の変更を行うことができる
* **パターン管理機能**:
  - SDカード/SPIFFSへのパターン保存・読み込み
  - シーケンサーアプリでパターンの編集と切り替えができる
  - ドラムパターンアプリでパターンの編集と切り替えができる
  - ベースアプリでパターンの編集と切り替えができる
  - コードガイドアプリでコード進行の新規作成と編集ができる
* **設定の永続化**:
  - 設定データのSDカード/SPIFFSへの保存

## 6. コンパニオンアプリとの連携

コンパニオンアプリの開発は別プロジェクトにて行いますが、連携のために本体側の機能も拡張する必要があります。

**通信プロトコル**: USB-CDC (シリアル通信) + JSONベースのカスタムプロトコル

**実装機能**:
* コンパニオンアプリ上でシーケンサーアプリのパターンを編集できる
  - リアルタイムプレビュー機能
* コンパニオンアプリ上でドラムアプリのパターンを編集できる
  - リアルタイムプレビュー機能
* コンパニオンアプリ上でコードガイドアプリのパターンを編集したり、MIDIファイルとして出力できる
* コンパニオンアプリ上で設定の変更を行うことができる
* コンパニオンアプリ上でファームウェアアップデートを行うことができる

**デバイス側の要件**:
* USB-CDC経由でのコマンド受信・応答
* パターンデータのJSON形式でのシリアライズ/デシリアライズ
* 設定データの読み書きAPI
* ファームウェアアップデート用のブートローダー連携

# 論理的依存関係チェーン
[開発の論理的順序を定義します：
- どの機能を最初に構築する必要があるか（基盤）
- 動作する使用可能/視覚的なフロントエンドにできるだけ早く到達する
- 各機能を適切にペーシングとスコーピングし、アトミックでありながら開発が進むにつれて構築・改善できるようにする]


# 性能要件

## レイテンシ

* **キー入力→音声出力**: 20ミリ秒以下 (内蔵音源使用時)
* **USB MIDI出力**: 外部デバイス依存 (特に規定しない)
* **BLE MIDI出力**: 外部デバイス依存 (特に規定しない)

## 同時発音数

* **最大ポリフォニー**: 32和音
* **内蔵音源チャンネル数**: 16チャンネル (チャンネル16はシステム音専用)

## バックグラウンド動作

* **同時動作アプリ数**: 当面制限なし (パフォーマンス問題が生じた場合に制限を検討)

# リスクと軽減策

## メモリ安全性

組み込みプロジェクトのため、メモリ関連のエラーが発生した際は、端末が即座に再起動する、スピーカーから不快な音が出力されるなど、ユーザー体験の低下に直結する事象が発生する恐れがあります。

**軽減策**:
- 静的メモリ割り当ての活用
- スマートポインタの使用 (CapsuleSamplerライブラリで既に採用)
- メモリプール方式の検討

## リアルタイム性

音響処理を扱うプロジェクトのため、特定のコアに負荷がかかった場合は音声処理が一時的に停止するなど、ユーザー体験の低下に直結する事象が発生する恐れがあります。

**軽減策**:
- 音声処理専用FreeRTOSタスクの使用 (既存実装)
- I2C操作の専用スレッド化 (既存実装)
- クリティカルセクションの最小化

## エラーハンドリングの方針

以下の項目は当面考慮しないものとします。

* バッテリー低下時の動作
* アプリクラッシュ時のフォールバック
* ストレージ容量不足時のエラー処理

# 付録

## 画面設計

詳細な画面設計は `docs/` フォルダ内に配置されています。

## 既存実装の参照

CapsuleChord2は既存のコードベースを持っており、CLAUDE.mdに詳細なアーキテクチャ情報が記載されています。

**主要コンポーネント**:
- `ChordPipeline`: 和音処理のパイプラインシステム
- `Context`: グローバル状態管理のシングルトン
- `TempoController`: テンポとタイミング管理
- `OutputInternal`: 内蔵音源 (CapsuleSamplerライブラリ使用)
- `AppBase`: アプリケーション基底クラス
- LVGL 8.3.4ベースのUI システム

**スレッディングモデル**:
- メインループ: コア1
- I2C操作: 専用スレッド (`I2CHandler`)
- 音声処理: 専用FreeRTOSタスク
- Tempo コールバック: FreeRTOSタイマー

## 用語集

* **ダイアトニックコード**: 特定のスケール(調)に含まれる7つの基本的な和音
* **ディグリーネーム**: スケールの度数で和音を表記する方法 (I, IIm, IIIm, IV, V, VIm, VIIdimなど)
* **コードネーム**: 絶対的な音名で和音を表記する方法 (C, Dm, Em, F, G, Am, Bdimなど)
* **ボイシング**: 和音を構成する音の配置方法
  - **クローズボイシング**: 和音の構成音を密集させた配置
  - **オープンボイシング**: 和音の構成音を広げた配置
* **転回形**: 和音の最低音を変更することで生まれる異なる配置
* **ポリフォニー**: 同時に発音できる音の数

## 技術的制約

* **ESP32-S3メモリ制約**:
  - SRAM: 512KB (PSRAMで拡張可能)
  - Flash: 16MB (M5Stack CoreS3)
* **LVGLメモリバッファ**: 画面描画用に一定のメモリを確保
* **CapsuleSamplerサンプル**: 音色サンプルデータがFlashメモリを消費
* **FreeRTOS**: タスク優先度とスタックサイズの適切な管理が必要
</PRD>
